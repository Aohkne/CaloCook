@startuml ForgotPassword

actor User as "User"
boundary "ForgotPassword Page" as View #lightblue
participant ":authRoute" as Route #lightblue
control "authController" as Controller #lightblue
participant ":authService" as Service #lightblue
entity "userModel" as Model #lightblue
database "MongoDB" as MongoDB #yellow
participant ":EmailService" as Mailer #pink

group Forgot Password
    User -> View: 1.Click "Forgot Password" on login page
    activate View
    activate User
    User -> View: 2.Enter email to reset password

    View -> View: 3.Validate email input
    activate View
    deactivate View
    
    opt Invalid email address
        View --> User: 3.1.Display "Please input correct email format."
    end

    View -> Route: 4.POST /api/v1/auth/forgotPassword
    activate Route
   
    Route -> Controller: 5.forgotPassword(req, res)
    activate Controller

    Controller -> Service: 6.forgotPassword(email)
    activate Service

    Service -> Model: 7.findUserByEmail(email) & generate OTP
    activate Model

    Model -> MongoDB: 8.Execute query
    activate MongoDB
    MongoDB --> Model: 9.Return user
    deactivate MongoDB

    Model --> Service: 10.Return user
    deactivate Model

    alt Email not registered
        Service --> Controller: 10.1.Return error "Email not found"
        Controller --> Route: 10.1.1.404 Not Found
        Route --> View: 10.1.2.Show "Email not found"
        View --> User: 10.1.3.Display error
    else Email found
        Service -> Mailer: 10.2.Send reset email with token/link
        activate Mailer
        Mailer --> Service: 10.2.1.Email sent
        deactivate Mailer

        Service --> Controller: 10.2.2.Return success
        deactivate Service
        Controller --> Route: 10.2.3.Return success
        deactivate Controller
        Route --> View: 10.2.4.Show success
        deactivate Route
        View --> User: 10.2.5.Display "Please check your email"
        deactivate View

        group OTP Verification & Reset Password
            User -> View: 11.Enter OTP & new password
            activate View
            View -> View: 12.Validate OTP & password
            activate View
            deactivate View

            opt Password not valid (not strong enough)
                View --> User: 12.1.Display "Password does not meet requirements"
            end

            View -> Route: 13.POST /api/v1/auth/resetPassword
            activate Route
            Route -> Controller: 14.verifyOtpAndResetPassword(req, res)
            activate Controller
            Controller -> Service: 15.verifyOtpAndResetPassword(otp, email, newPassword)
            activate Service
            

            alt OTP invalid or expired
                Service --> Controller: 15.1.Return error "Invalid or expired OTP"
                Controller --> Route: 15.1.1.Return error
                Route --> View: 15.1.2.Show "Invalid or expired OTP"
                View --> User: 15.1.3.Display error
            else OTP input attempts exceeded
                Service --> Controller: 15.2.Return error "Too many attempts, OTP cancelled"
                Controller --> Route: 15.2.1.Return error
                Route --> View: 15.2.2.Show "Too many attempts, OTP cancelled"
                View --> User: 15.2.3.Display error
            else OTP valid
                Service -> Model: 15.3.FindAndUpdate(email, newPassword)
                activate Model
                Model -> MongoDB: 15.3.1.Update user password
                activate MongoDB
                MongoDB --> Model: 15.3.2.Password updated
                deactivate MongoDB
                Model --> Service: 15.3.3.Return success
                deactivate Model

                Service --> Controller: 15.3.4.Return success
                deactivate Service
                Controller --> Route: 15.3.5.Return success
                deactivate Controller
                Route --> View: 15.3.5.Show success
                deactivate Route
                View --> User: 15.3.5."Password reset successfully"
                deactivate View
                deactivate User
            end
        end
    end
end

@enduml
