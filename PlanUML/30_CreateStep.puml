@startuml CreateStep

actor "Admin" as Admin
boundary "StepManagementPage" as View #lightblue
participant ":stepRoute" as Route #lightblue
participant ":stepValidation" as Validation #orange
control "stepController" as Controller #lightblue
participant ":stepService" as Service #lightblue
entity "stepModel" as Model #lightblue
entity "dishModel" as DishModel #lightblue
database "MongoDB" as MongoDB #yellow

group Create New Step
Admin -> View: 1. Fill step form (dishId, stepNumber, description)
activate Admin
activate View

View -> Route: 2. POST /api/v1/step
activate Route

Route -> Validation: 3. createNew validation
activate Validation

Validation -> Validation: 4. Validate dishId, stepNumber, description, isActive

alt Validation Success
    Validation -> Controller: 5. createNew(req, res)
    activate Controller

    Controller -> Service: 6. createNew(reqBody)
    activate Service

    Service -> DishModel: 7. getDetails(dishId) - verify dish exists
    activate DishModel
    
    DishModel -> MongoDB: 8. ExecuteQuery()
    activate MongoDB
    
    MongoDB --> DishModel: 9. Return dish data
    
    DishModel --> Service: 10. Return dish or null
    deactivate DishModel

    alt Dish Found
        Service -> Model: 11. createNew(newStepData)
        activate Model

        Model -> MongoDB: 12. ExecuteQuery()

        MongoDB --> Model: 13. Return insertedId

        Model -> MongoDB: 14. ExecuteQuery()

        MongoDB --> Model: 15. Return created step
        deactivate MongoDB

        Model --> Service: 16. Return created step
        deactivate Model

        Service --> Controller: 17. Return created step

        Controller --> Route: 18. Send JSON response (201, created step)

        Route --> View: 19. Show success message

        View --> Admin: 20. Display created step

    else Dish Not Found
        Service --> Controller: 10.1 Throw ApiError(404, "Dish not found!")
        deactivate Service

        Controller --> Route: 10.2 next(error)
        deactivate Controller

        Route --> View: 10.3 Return 404 error

        View --> Admin: 10.4 Show error message

    end

else Validation Failed
    Validation --> Route: 4.1 Throw validation error
    deactivate Validation

    Route --> View: 4.2 Return validation error
    deactivate Route

    View --> Admin: 4.3 Display validation errors
    deactivate View
    deactivate Admin
end

end

@enduml