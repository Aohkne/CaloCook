@startuml Export Dish List

actor Admin as "Admin"
boundary "DishListExportPage" as View #lightblue
participant ":dishRoute" as Route #lightblue
control "authMiddleware" as Auth #orange
control "dishController" as Controller #lightblue
participant ":dishService" as Service #lightblue
entity "dishModel" as Model #lightblue
database "MongoDB" as MongoDB #yellow
participant ":exportHelper" as Helper #lightgreen

Group Export Dish List
Admin -> View: 1. Click "Export" button
activate Admin
activate View

Admin -> View: 2. Select export type (Excel/CSV)\nand apply filters (optional)
Admin -> View: 3. Confirm export

View -> Route: 4. GET /api/v1/dish/export/{type}\n(params: name, minCookingTime, maxCookingTime,\nminCalorie, maxCalorie, difficulty, isActive)
activate Route

Route -> Auth: 5. authenticateUser(req) &\nauthorizeRole(['admin'])
activate Auth

ref over Auth : 6. 3.0 Verify Token & Check Role

opt Authentication/Authorization Failed
    Auth --> Route: 6.1. Return 401/403 Error
    Route --> View: 6.2. Show error
    View --> Admin: 6.3. Display error message
end

Auth --> Route: 7. User authenticated & authorized
deactivate Auth

Route -> Controller: 8. exportExcel(req, res) | exportCSV(req, res)
activate Controller

Controller -> Service: 9. getAllForExport(filters)
activate Service

Service -> Model: 10. getAllForExport(combinedFilters, maxLimit)
activate Model

Model -> MongoDB: 11. ExecuteQuery(find with filters)
activate MongoDB
MongoDB --> Model: 12. Return dishes array
deactivate MongoDB

Model --> Service: 13. Return dishes data
deactivate Model

Service --> Controller: 14. Return dishes array
deactivate Service

opt No dishes found
    Controller --> Route: 14.1. Show error message
    Route --> View: 14.2. Show error message
    View --> Admin: 14.3. Display "No dishes found to export"
end

alt Export Type = Excel

    Controller -> Helper: 15.1. generateDishExcelFile(dishes)
    activate Helper
    
    Helper --> Controller: 15.1.1. Return Excel buffer
    deactivate Helper
    
else Export Type = CSV
    Controller -> Helper: 15.2. generateDishCSVFile(dishes)
    activate Helper
    
    Helper --> Controller: 15.2.1. Return CSV string
    deactivate Helper
end

Controller --> Route: 16. Return 200 OK + file buffer/string
deactivate Controller

Route --> View: 17. Return file blob
deactivate Route


View --> Admin: 18. File downloaded successfully
deactivate Admin
deactivate View

end

@enduml