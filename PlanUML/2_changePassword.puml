@startuml changePassword

actor User as "User"
boundary "ChangePassword Page" as View #lightblue
participant ":authRoute" as Route #lightblue
control "authController" as Controller #lightblue
participant ":authService" as Service #lightblue
entity "userModel" as Model #lightblue
database "MongoDB" as MongoDB #yellow

group Change Password
User -> View: 1.Enter oldPassword, newPassword
activate View
activate User

View -> View: 2.Validate input
View -> Route: 3.POST /api/v1/auth/changePassword
activate Route

Route -> Controller: 4.changePassword(req, res)
activate Controller

Controller -> Service: 5.changePassword\n(userId, oldPassword, newPassword)
activate Service

Service -> Model: 6.findUserById(userId)
activate Model

Model -> MongoDB: 7.ExecuteQuery()
activate MongoDB
MongoDB --> Model: 8.Return result

Model --> Service: 9.Return result

Service -> Service: 10.Compare {oldPassword, newPassword}

alt Incorrect old password
    Service --> Controller: 11.Return fail 
    Controller --> Route: 11.1.Return fail
    Route --> View: 11.2.Show error
    View --> User: 11.3.Display "Old password is incorrect"

else New password same as old password
    Service --> Controller: 12.Return fail 
    Controller --> Route: 12.1.Return fail
    Route --> View: 12.2.Show error
    View --> User: 12.3.Display "New password cannot same old password"

else Weak new password
    Service --> Controller: 13.Return fail 
    Controller --> Route: 13.1.Return fail
    Route --> View: 13.2.Show error
    View --> User: 13.3.Display "Password must least 6 characters"

else Correct old password and strong new password
    Service -> Service: 14.Hash new password
    Service -> Model: 15.updatePassword\n(userId, newHashedPassword)

    Model -> MongoDB: 16.ExecuteQuery()
    MongoDB --> Model: 17.Return result
    deactivate MongoDB

    Model --> Service: 18.Return result
    deactivate Model

    Service --> Controller: 19.Return success
    deactivate Service

    Controller --> Route: 20.Return success
    deactivate Controller

    Route --> View: 21.Show success
    deactivate Route

    View --> User: 22.Display "Changed successfully"
    deactivate View
    deactivate User
end
end 
@enduml
