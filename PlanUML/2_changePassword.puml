@startuml changePassword

actor User as "User/Admin"
boundary "ChangePasswordView" as View #lightblue
participant ":authRoute" as Route #lightblue
control "authController" as Controller #lightblue
participant ":authService" as Service #lightblue
entity "userModel" as Model #lightblue
database "MongoDB" as MongoDB #yellow


group Change Password
User -> View: 1.Enter oldPassword, newPassword
activate View

View -> View: 2.Validate input
View -> Route: 3.POST /api/v1/auth/changePassword
activate Route

Route -> Controller: 4.changePassword(req, res)
activate Controller

Controller -> Service: 5.changePassword\n(userId, oldPassword, newPassword)
activate Service

Service -> Model: 6.findUserById(userId)
activate Model

Model -> MongoDB: 7.ExecuteQuery()
activate MongoDB
MongoDB --> Model: 8.Return result
deactivate MongoDB

Model --> Service: 9.Return result
deactivate Model

Service -> Service: 10.Compare {oldPassword, hashedPassword}

alt Incorrect old password
    Service --> Controller: 11.Return fail "Incorrect password"
    deactivate Service

    Controller --> Route: 11.1.Return fail
    deactivate Controller

    Route --> View: 11.2.Show error
    deactivate Route

    View --> User: 11.3.Display "Old password is incorrect"

else Correct old password
    Service -> Service: 11.Hash new password
    Service -> Model: 12.updatePassword\n(userId, newHashedPassword)
    activate Model

    Model -> MongoDB: 13.ExecuteQuery()
    activate MongoDB
    MongoDB --> Model: 14.Return result
    deactivate MongoDB

    Model --> Service: 15.Return result
    deactivate Model

    Service --> Controller: 16.Return success
    deactivate Service

    Controller --> Route: 17.Return success
    deactivate Controller

    Route --> View: 18.Show success
    deactivate Route

    View --> User: 19.Display "Changed successfully"
end
end 
@enduml
