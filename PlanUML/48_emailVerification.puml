@startuml EmailVerification

actor User as "Customer"
boundary "Profile Page" as View #lightblue
participant ":authRoute" as Route #lightblue
control "authController" as Controller #lightblue
participant ":authService" as Service #lightblue
entity "userModel" as Model #lightblue
database "MongoDB" as DB #yellow
participant "Email Service Provider" as ESP #pink

group Email Verification
User -> View: 1.Navigate to Profile Page
activate View
activate User

View -> Route: 2.GET /api/v1/auth/profile
activate Route

Route -> Controller: 3.getProfile(req, res)
activate Controller

Controller -> Service: 4.checkEmailStatus(userId)
activate Service

Service -> Model: 5.findUserById(userId)
activate Model

Model -> DB: 6.Query user by ID
activate DB
DB --> Model: 7.Return user data
deactivate DB

Model --> Service: 8.Return user
deactivate Model

Service --> Controller: 9.Return email status (Not Verified)
deactivate Service
Controller --> Route: 10.Return profile data
deactivate Controller
Route --> View: 11.Render profile page (Not Verified)
deactivate Route

View --> User: 12.Show "Verify Email" button

User -> View: 13.Click "Verify Email"
View -> Route: 14.POST /api/v1/auth/verifyEmail
activate Route

Route -> Controller: 15.verifyEmail(req, res)
activate Controller

Controller -> Service: 16.generateVerificationToken(userId)
activate Service

Service -> DB: 17.Store token with expiration
activate DB
DB --> Service: 18.Success
deactivate DB

Service -> ESP: 19.Send email with verification link
activate ESP
ESP --> User: 20.Receive email with link
deactivate ESP

Service --> Controller: 21.Return success
deactivate Service
Controller --> Route: 22.Return success
deactivate Controller
Route --> View: 23.Show "Verification email sent"
deactivate Route
View --> User: 24.Notify "Check your email"

User -> ESP: 25.Click verification link
activate ESP
ESP -> Route: 26.GET /api/v1/auth/verify?token=xxx
deactivate ESP
activate Route

Route -> Controller: 27.verifyToken(req, res)
activate Controller

Controller -> Service: 28.validateToken(token)
activate Service

Service -> DB: 29.Check token validity
activate DB
DB --> Service: 30.Token info
deactivate DB

alt Token valid and not expired
    Service -> DB: 30.1.Update email status = Verified
    activate DB
    DB --> Service: 30.1.1.Success
    deactivate DB

    Service --> Controller: 30.1.2. Return success

    Controller --> Route: 30.1.3.Return success

    Route --> View: 30.1.4."Email successfully verified"

    View --> User: 30.1.5."Email successfully verified"
else Token expired or invalid
    Service --> Controller: 30.2.Return error
    deactivate Service

    Controller --> Route: 30.2.1.Return error message
    deactivate Controller

    Route --> View: 30.2.2.Return error message
    deactivate Route
    Route --> User: 30.2.3."Invalid or expired token"

    deactivate User
    deactivate View
end
end

@enduml
